parameters:
  job:
    name: ''
    displayName: ''
  pool: ''
  build:
    configuration: 'Release'

jobs:
- job: ${{ parameters.job.name }}
  displayName: ${{ parameters.job.displayName }}
  continueOnError: False
  pool: ${{ parameters.pool }}
  steps:
  # Install specific .NET Core SDK version.
  # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/tool/dotnet-core-tool-installer?view=vsts.
  # Installing a specific .NET Core SDK version is needed to avoid installing a .NET Core global tool in a following task and then have Azure DevOps complain that it cannot find it.
  # This issue is documented here: https://github.com/Microsoft/azure-pipelines-tasks/issues/8291.
  - task: DotNetCoreInstaller@0
    displayName: Install .NET Core SDK
    name: install_dotnetcore_sdk
    enabled: true
    inputs:
      packageType: 'sdk'
      version: '2.1.500'
  # Install sonarscanner tool to be able to perform a SonarQube analysis.
  # See more here: https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+MSBuild.
  - task: DotNetCoreCLI@2
    displayName: Install SonarQube static code analyzing CLI tool
    name: install_sonarscanner
    enabled: true
    inputs:
      command: custom
      custom: tool
      arguments: 'install dotnet-sonarscanner --global --version 4.4.2'
  # Prepare SonarQube analysis.
  # See more here: https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+MSBuild.
  # The analysis will make use of the branch name via the "sonar.branch.name" command parameter.
  # See more here: https://sonarcloud.io/documentation/branches/overview/#analysis.
  - script: dotnet-sonarscanner begin /k:"aspnet-core-logging" /s:"$(Build.SourcesDirectory)/Build/SonarQubeAnalysis.xml" /d:sonar.login="$(SonarLogin)" /d:sonar.branch.name="$(Build.SourceBranchName)"
    displayName: Prepare SonarQube analysis
    name: prepare_sonarqube_analysis
    enabled: true
  # Compile source code.
  # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/dotnet-core-cli?view=vsts.
  - task: DotNetCoreCLI@2
    displayName: Build sources
    name: build_sources
    enabled: true
    inputs:
      command: custom
      custom: build
      arguments: '$(Build.SourcesDirectory)/Todo.sln --configuration ${{ parameters.build.configuration }}'
  # Run unit tests.
  # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/dotnet-core-cli?view=vsts.
  - task: DotNetCoreCLI@2
    displayName: Run unit tests
    name: run_unit_tests
    enabled: true
    inputs:
      command: custom
      custom: test
      projects: $(Build.SourcesDirectory)/Todo.sln
      arguments: '--filter "FullyQualifiedName~.UnitTests." --configuration ${{ parameters.build.configuration }} --no-build --logger "trx;LogFileName=TestResults.trx" /p:CollectCoverage=true'
  # Run integration tests.
  # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/dotnet-core-cli?view=vsts.
  - task: DotNetCoreCLI@2
    displayName: Run integration tests
    name: run_integration_tests
    enabled: true
    inputs:
      command: custom
      custom: test
      projects: $(Build.SourcesDirectory)/Todo.sln
      arguments: '--filter "FullyQualifiedName~.IntegrationTests." --configuration ${{ parameters.build.configuration }} --no-build --logger "trx;LogFileName=TestResults.trx" /p:CollectCoverage=true'
  # Publish test results.
  # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/test/publish-test-results?view=vsts&tabs=yaml.
  - task: PublishTestResults@2
    displayName: Publish test results
    name: publish_test_results
    enabled: true
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '$(Build.SourcesDirectory)/Tests/**/*.trx'
      mergeTestResults: True
      buildConfiguration: ${{ parameters.build.configuration }}
      publishRunAttachments: True
  # Install reportgenerator tool to be able to generate code coverage HTML report.
  # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/dotnet-core-cli?view=vsts.
  - task: DotNetCoreCLI@2
    displayName: Install code coverage report generator tool
    name: install_code_coverage_report_generator
    enabled: true
    inputs:
      command: custom
      custom: tool
      arguments: 'install dotnet-reportgenerator-globaltool --global --version 4.0.3'
  # Generate code coverage HTML report based on coverage data XML files.
  # See more here: https://github.com/danielpalme/ReportGenerator#usage.
  # See more about the output formats here: https://github.com/danielpalme/ReportGenerator/wiki/Output-formats.
  - script: 'reportgenerator "-reports:$(Build.SourcesDirectory)/CodeCoverage/Results/*.xml" "-targetdir:$(Build.SourcesDirectory)/CodeCoverage/Report" "-reporttypes:HtmlInline"'
    displayName: Generate code coverage report
    name: generate_code_coverage_report
    enabled: false
  # Publish code coverage report.
  # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/test/publish-code-coverage-results?view=vsts.
  - task: PublishCodeCoverageResults@1
    displayName: Publish code coverage report
    name: publish_code_coverage_report
    enabled: false
    inputs:
      codeCoverageTool: 'cobertura'
      summaryFileLocation: '$(Build.SourcesDirectory)/CodeCoverage/Results/*.xml'
      reportDirectory: '$(Build.SourcesDirectory)/CodeCoverage/Report'
      additionalCodeCoverageFiles: '$(Build.SourcesDirectory)/CodeCoverage/Report/index.html'
  # Upload SonarQube report to SonarCloud.
  # See more here: https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+MSBuild.
  - script: dotnet-sonarscanner end /d:sonar.login="$(SonarLogin)"
    displayName: Upload SonarQube report
    name: upload_sonarqube_report
    enabled: true