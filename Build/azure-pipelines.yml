# Build ASP.NET Core project using Azure Pipelines.
# See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/languages/dotnet-core?view=azure-devops.
# YAML schema reference: https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema.

# Specify build number format.
# See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/process/run-number?view=azure-devops&tabs=yaml.
name: '$(SourceBranchName)_$(Date:yyyyMMdd).$(Rev:rrr)'

resources:
  repositories: 
  # See more about repositories here: https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema#repository-resource.
  - repository: self
    type: 'github'
    name: 'satrapu/aspnet-core-logging'
    clean: True
    # The value of the "endpoint" element must match the service connection name 
    # declared in Project Settings -> Service connections section of your Azure DevOps organization.
    endpoint: 'satrapu'
    # Build multiple branches.
    # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/build/ci-build-git?view=azure-devops&tabs=yaml.
    trigger:
      branches:
        include:
          - master
          - feature/*
          - bugfix/*
          - hotfix/*
          - release/*

# See more about Azure Pipelines variables here: https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&tabs=yaml%2Cbatch.
variables:
  # Environment variable used when caching restored NuGet packages.
  # See more about this variable here: https://docs.microsoft.com/en-us/nuget/reference/cli-reference/cli-ref-environment-variables.
  # See more about caching NuGet packages here: https://docs.microsoft.com/en-us/azure/devops/pipelines/release/caching?view=azure-devops#netnuget.
  - name: 'NUGET_PACKAGES'
    value: '$(Pipeline.Workspace)/.nuget/packages'

  # Avoid caching NuGet packages each time a build runs on an Azure DevOps agent.
  # See more here: http://donovanbrown.com/post/Stop-wasting-time-during-NET-Core-builds.
  - name: 'DOTNET_SKIP_FIRST_TIME_EXPERIENCE'
    value: '1'

  # Disable .NET Core telemetry.
  # See more here: https://docs.microsoft.com/en-us/dotnet/core/tools/telemetry#how-to-opt-out.
  - name: 'DOTNET_CLI_TELEMETRY_OPTOUT'
    value: '1'

  # Disable Core CLR tracing.
  # See more here: https://docs.microsoft.com/en-us/dotnet/core/dependency-loading/default-probing#how-do-i-debug-the-probing-properties-construction.
  - name: 'COREHOST_TRACE'
    value: '0'

  # Load group containing variables applicable to all pipelines belonging to this project.
  - group: 'GlobalVariables'

  # Load SonarQube related variable group.
  # See more here: https://docs.microsoft.com/en-us/azure/devops/pipelines/library/variable-groups?view=azure-devops&tabs=yaml#use-a-variable-group.
  # Be sure to link this group to this pipeline by selecting the latter -> Edit -> Variables -> Variable Groups!
  - group: 'SonarQube'

  # Load group containing variables applicable to integration tests.
  # This group contains the password to be used when accessing the dockerized database targeted by the integration tests.
  # This password is stored as a secret under the name "IntegrationTests.Database.Todo.Password".
  # See more about secret variables here: https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&tabs=yaml%2Cbatch#secret-variables.
  - group: 'IntegrationTests'

  # Specifies the version of the .NET Core SDK to install and use when running this pipeline.
  # All releases can be found here: https://dotnet.microsoft.com/download/dotnet-core.
  - name: 'DotNetCore_SDK_Version'
    value: '3.1.302'

  # Specifies the version of the ReportGenerator tool used for generating code coverage reports.
  # All releases can be found here: https://github.com/danielpalme/ReportGenerator/releases.
  # All NuGet packages can be found here: https://www.nuget.org/packages/ReportGenerator/.
  - name: 'ReportGenerator_Version'
    value: '4.5.8'

  # Represents the name of the database to be targeted by integration tests
  - name: 'IntegrationTests.Database.Todo.Name'
    value: 'todo-db4it'

  # Represents the user used for accessing the database to be targeted by integration tests
  - name: 'IntegrationTests.Database.Todo.Username'
    value: 'satrapu'
    
stages:
  - stage: 'checkout'
    displayName: 'Checkout'
    jobs:
      - template: azure-pipelines.job-templates.checkout.yml@self

  - stage: 'prerequisites'
    displayName: 'Prerequisites'
    dependsOn: 'checkout'
    jobs:
      - template: azure-pipelines.job-templates.prerequisites.yml@self
        parameters:
          dotNetCoreSdkVersion: $(DotNetCore_SDK_Version)
          cacheRestoredNuGetPackages: False
          sonar:
            enabled: True
            sonarCloud:
              endpointName: 'sonar-cloud'
              organization: 'satrapu-github'
              projectKey: 'aspnet-core-logging'
              # The 'CurrentProject.Version' variable has been declared inside 
              # the 'GlobalVariables' variable group.
              projectVersion: $(CurrentProject.Version)

  - stage: 'build'
    displayName: 'Build'
    dependsOn: 'prerequisites'
    jobs:
      - job:
        displayName: 'Build web API'
        steps:
          - checkout: none
          - script: echo 'Building ASP.NET Core web API'

  - stage: 'test'
    displayName: 'Run Tests'
    dependsOn: 'build'
    jobs:
      - job:
        displayName: Run unit tests
        steps:
          - checkout: none
          - script: echo 'Running unit tests'
      - job:
        displayName: Run integration tests
        steps:
          - checkout: none
          - script: echo 'Running integration tests'

  - stage: 'code_quality'
    displayName: 'Ensure Code Quality'
    dependsOn: 'test'
    jobs:
    - job:
      displayName: Run Sonar
      steps:
        - checkout: none
        - script: echo 'Running Sonar analysis'

